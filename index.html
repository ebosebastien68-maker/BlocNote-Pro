<!DOCTYPE html>
<html lang="fr" data-theme="dark">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Studio de Code Pro</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Fira+Code&family=JetBrains+Mono&family=Roboto+Mono&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --font-sans: 'Inter', sans-serif;
            --font-mono: 'Fira Code', monospace;
        }
        [data-theme='dark']{--bg-primary:#0D1117;--bg-secondary:#161B22;--bg-tertiary:#21262D;--border-color:#30363D;--text-primary:#C9D1D9;--text-secondary:#8B949E;--accent-color:#58A6FF;--danger-color:#F85149;}
        [data-theme='light']{--bg-primary:#FFFFFF;--bg-secondary:#F6F8FA;--bg-tertiary:#F0F2F5;--border-color:#D0D7DE;--text-primary:#1F2328;--text-secondary:#57606A;--accent-color:#0969DA;--danger-color:#CF222E;}

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        body {
            font-family: var(--font-sans);
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color .2s, color .2s;
        }

        .app {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 1800px;
            margin: 0 auto;
            padding: 1rem;
        }

        *{box-sizing:border-box;}

        header{display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem; flex-shrink: 0;}
        h1{margin:0;font-size:22px;}
        .subtitle{color:var(--text-secondary);font-size:14px;}

        .main-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            flex-grow: 1;
            min-height: 0;
        }
        .editor-area, .preview-area {
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        .card {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
            margin-bottom: 20px;
            padding: 12px;
        }
        fieldset{border:1px solid var(--border-color);border-radius:6px;padding:8px 12px;display:flex;gap:8px;align-items:center;}
        legend{font-size:12px;font-weight:600;color:var(--text-secondary);padding:0 4px;}
        .btn{background-color:var(--bg-tertiary);border:1px solid var(--border-color);padding:8px 12px;border-radius:6px;color:var(--text-primary);font-family:var(--font-sans);font-size:14px;transition:background-color .2s,border-color .2s;cursor:pointer;font-weight:600;}
        .btn:hover{border-color:var(--accent-color);}
        .btn.primary{background-color:var(--accent-color);color:white;border-color:var(--accent-color);}
        .btn.primary:hover{opacity:0.9;}
        .btn[disabled]{opacity:0.5;cursor:not-allowed;}

        .editor-card {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            padding: 0;
        }
        .tabs-container {
            display: flex;
            flex-shrink: 0;
            background-color: var(--bg-primary);
            padding: 8px 8px 0 8px;
            border-bottom: 1px solid var(--border-color);
        }
        .tab {
            padding: 8px 16px;
            cursor: pointer;
            border-radius: 6px 6px 0 0;
            border: 1px solid transparent;
            border-bottom: none;
            color: var(--text-secondary);
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .tab:hover {
            background-color: var(--bg-tertiary);
        }
        .tab.active {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            border-color: var(--border-color);
        }
        .close-tab {
            border: none; background: none; color: inherit; cursor: pointer; opacity: 0.6;
        }
        .close-tab:hover { opacity: 1; }
        .add-tab-btn { padding: 8px; font-size: 16px; line-height: 1; }

        #editorContainer {
            flex-grow: 1;
            border-radius: 0 0 8px 8px;
            overflow: hidden;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--text-secondary);
            padding: 6px 16px;
            background-color: var(--bg-primary);
            border-top: 1px solid var(--border-color);
            border-radius: 0 0 8px 8px;
        }

        .preview-card {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        .preview-header {
            margin-bottom: 12px;
        }
        .preview-header h3 {
            margin: 0;
            display: inline;
            margin-right: 8px;
        }
        #previewFrame {
            flex-grow: 1;
            width: 100%;
            border: none;
            background-color: white;
            border-radius: 6px;
        }

        .theme-switcher{display:flex;align-items:center;gap:8px;}
        .switch{position:relative;display:inline-block;width:44px;height:24px;}
        .switch input{opacity:0;width:0;height:0;}
        .slider{position:absolute;cursor:pointer;inset:0;background-color:#ccc;border-radius:34px;transition:.4s;}
        .slider:before{position:absolute;content:"";height:18px;width:18px;left:3px;bottom:3px;background-color:white;border-radius:50%;transition:.4s;}
        input:checked + .slider{background-color:var(--accent-color);}
        input:checked + .slider:before{transform:translateX(20px);}
        .notification{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);padding:12px 20px;border-radius:6px;background-color:var(--accent-color);color:white;font-weight:600;opacity:0;visibility:hidden;transition:opacity .3s,visibility .3s;}
        .notification.show{opacity:1;visibility:visible;}
        .notification.error{background-color:var(--danger-color);}

        @media (max-width: 1200px) {
            .main-layout { grid-template-columns: 1fr; }
            .preview-area { margin-top: 20px; }
        }
    </style>
</head>
<body>
    <div class="app">
        <header>
            <div>
                <h1>Studio de Code Pro</h1>
                <div class="subtitle">√âditeur multi-fichiers avec aper√ßu en direct</div>
            </div>
            <div class="theme-switcher">
                <span>‚òÄÔ∏è</span>
                <label class="switch"><input type="checkbox" id="themeToggle" checked><span class="slider"></span></label>
                <span>üåô</span>
            </div>
        </header>

        <main class="main-layout">
            <div class="editor-area">
                <div class="card controls">
                    <fieldset>
                        <legend>Fichier</legend>
                        <input id="fileInput" type="file" style="display:none" />
                        <button id="btnOpenFile" class="btn">üìÇ Ouvrir</button>
                        <button id="btnSaveNote" class="btn">üíæ T√©l√©charger</button>
                    </fieldset>
                    <fieldset>
                        <legend>√âdition</legend>
                        <button id="btnFormatCode" class="btn">üé® Formater</button>
                        <button id="btnFind" class="btn">üîç Chercher</button>
                        <button id="btnRunCode" class="btn primary">‚ñ∂Ô∏è Ex√©cuter</button>
                    </fieldset>
                </div>

                <div class="card editor-card">
                    <div class="tabs-container" id="tabsContainer">
                        </div>
                    <div id="editorContainer"></div>
                    <div class="status-bar" id="statusBar">
                        <span>Ligne: 1, Colonne: 1</span>
                        <span id="charCount">0 caract√®res</span>
                        <span>UTF-8</span>
                    </div>
                </div>
            </div>

            <aside class="preview-area">
                <div class="card preview-card">
                    <div class="preview-header">
                        <h3>Aper√ßu</h3>
                        <span class="subtitle">S'actualise avec ‚ñ∂Ô∏è Ex√©cuter</span>
                    </div>
                    <iframe id="previewFrame" title="Aper√ßu du code"></iframe>
                </div>
            </aside>
        </main>
    </div>

    <div id="notification" class="notification"></div>
    
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs/loader.js"></script>
    <script src="https://unpkg.com/prettier@2.8.8/standalone.js"></script>
    <script src="https://unpkg.com/prettier@2.8.8/parser-babel.js"></script>
    <script src="https://unpkg.com/prettier@2.8.8/parser-html.js"></script>
    <script src="https://unpkg.com/prettier@2.8.8/parser-postcss.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            const DOM = {
                btnOpenFile: document.getElementById('btnOpenFile'),
                btnSaveNote: document.getElementById('btnSaveNote'),
                btnFormatCode: document.getElementById('btnFormatCode'),
                btnFind: document.getElementById('btnFind'),
                btnRunCode: document.getElementById('btnRunCode'),
                fileInput: document.getElementById('fileInput'),
                tabsContainer: document.getElementById('tabsContainer'),
                editorContainer: document.getElementById('editorContainer'),
                previewFrame: document.getElementById('previewFrame'),
                statusBar: document.getElementById('statusBar'),
                charCount: document.getElementById('charCount'),
                notification: document.getElementById('notification'),
                themeToggle: document.getElementById('themeToggle')
            };

            const state = {
                editor: null,
                files: [],
                activeFileId: null,
                nextFileId: 1,
                notificationTimeout: null
            };

            require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs' } });
            require(['vs/editor/editor.main'], () => {
                state.editor = monaco.editor.create(DOM.editorContainer, {
                    theme: 'vs-dark',
                    automaticLayout: true,
                    fontFamily: 'Fira Code',
                    fontSize: 14
                });

                loadSession();
                if (state.files.length === 0) {
                    createNewFile();
                }
                
                initEventListeners();
                updateUI();
            });

            function createNewFile(name, content) {
                if (!name) {
                    const defaultName = `sans-titre-${state.nextFileId}.html`;
                    const providedName = prompt("Entrez le nom du nouveau fichier :", defaultName);
                    if (providedName === null) return; // L'utilisateur a annul√©
                    name = providedName || defaultName;
                }
                content = content || '<h1>Bonjour le monde !</h1>\n<p>Cliquez sur "‚ñ∂Ô∏è Ex√©cuter" pour voir le r√©sultat.</p>';

                const existingFile = state.files.find(f => f.name === name);
                if (existingFile) {
                    switchToFile(existingFile.id);
                    showNotification("Ce fichier est d√©j√† ouvert.", "info");
                    return;
                }
                
                const file = {
                    id: state.nextFileId++,
                    name,
                    content,
                    model: monaco.editor.createModel(content, detectLanguage(name))
                };
                state.files.push(file);
                switchToFile(file.id);
            }
            
            function switchToFile(id) {
                const file = state.files.find(f => f.id === id);
                if (!file) return;

                const currentFile = getActiveFile();
                if (currentFile) currentFile.viewState = state.editor.saveViewState();

                state.activeFileId = id;
                state.editor.setModel(file.model);

                if (file.viewState) state.editor.restoreViewState(file.viewState);
                state.editor.focus();
                updateUI();
            }
            
            function closeFile(id) {
                const index = state.files.findIndex(f => f.id === id);
                if (index === -1) return;

                state.files.splice(index, 1);
                
                if (state.activeFileId === id) {
                    const newActiveFile = state.files[index] || state.files[index - 1];
                    if (newActiveFile) {
                        switchToFile(newActiveFile.id);
                    } else {
                        state.activeFileId = null;
                        state.editor.setModel(null);
                    }
                }
                
                if (state.files.length === 0) {
                    createNewFile('index.html', '<h1>Projet Vide</h1>');
                }

                updateUI();
            }
            
            function updateUI() {
                DOM.tabsContainer.innerHTML = '';
                state.files.forEach(file => {
                    const tab = document.createElement('div');
                    tab.className = `tab ${file.id === state.activeFileId ? 'active' : ''}`;
                    tab.dataset.id = file.id;
                    tab.innerHTML = `
                        <span>${file.name}</span>
                        <button class="close-tab" data-id="${file.id}" aria-label="Fermer l'onglet ${file.name}">√ó</button>
                    `;
                    DOM.tabsContainer.appendChild(tab);
                });
                const addTabBtn = document.createElement('button');
                addTabBtn.className = 'btn add-tab-btn';
                addTabBtn.textContent = '+';
                addTabBtn.setAttribute('aria-label', 'Cr√©er un nouvel onglet');
                DOM.tabsContainer.appendChild(addTabBtn);

                updateStatusBar();
                saveSession();
            }
            
            function updateStatusBar() {
                if (!state.editor || !state.activeFileId) return;
                const position = state.editor.getPosition();
                const model = state.editor.getModel();
                DOM.statusBar.children[0].textContent = `Ligne: ${position.lineNumber}, Colonne: ${position.column}`;
                DOM.charCount.textContent = `${model.getValueLength()} caract√®res`;
            }

            function runCode() {
                const file = getActiveFile();
                if (!file) return;

                DOM.previewFrame.srcdoc = file.model.getValue();
                showNotification("Code ex√©cut√© dans l'aper√ßu !", "success");
            }

            async function formatCode() {
                const file = getActiveFile();
                if (!file) return;

                const lang = detectLanguage(file.name);
                const parserMap = { 'html': 'html', 'css': 'css', 'javascript': 'babel' };

                if (!parserMap[lang]) {
                    showNotification(`Le formatage pour '${lang}' n'est pas support√©.`, 'error');
                    return;
                }

                try {
                    const formatted = prettier.format(file.model.getValue(), {
                        parser: parserMap[lang],
                        plugins: prettierPlugins,
                    });
                    file.model.setValue(formatted);
                    showNotification("Code format√© avec succ√®s.", "success");
                } catch (e) {
                    showNotification("Erreur de formatage.", "error");
                }
            }
            
            function downloadActiveFile() {
                const file = getActiveFile();
                if (!file) return;
                
                const blob = new Blob([file.model.getValue()], {type: "text/plain;charset=utf-8"});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = file.name;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showNotification(`'${file.name}' t√©l√©charg√©.`, 'success');
            }

            function openFile(event) {
                const fileData = event.target.files[0];
                if (!fileData) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        createNewFile(fileData.name, e.target.result);
                    } catch (err) {
                        showNotification("Erreur lors de la lecture du fichier.", "error");
                    }
                };
                reader.onerror = function() {
                    showNotification("Impossible de lire le fichier.", "error");
                };
                reader.readAsText(fileData);
                DOM.fileInput.value = ''; // Permet de r√©-ouvrir le m√™me fichier
            }

            function saveSession() {
                const sessionData = {
                    files: state.files.map(f => ({ id: f.id, name: f.name, content: f.model.getValue() })),
                    activeFileId: state.activeFileId,
                    nextFileId: state.nextFileId
                };
                localStorage.setItem('codeStudioSession', JSON.stringify(sessionData));
            }
            
            function loadSession() {
                const sessionData = localStorage.getItem('codeStudioSession');
                if (sessionData) {
                    const parsed = JSON.parse(sessionData);
                    state.files = parsed.files.map(f => ({
                        ...f,
                        model: monaco.editor.createModel(f.content, detectLanguage(f.name))
                    }));
                    state.activeFileId = parsed.activeFileId;
                    state.nextFileId = parsed.nextFileId;
                }
            }
            
            function getActiveFile() {
                if (!state.activeFileId) return null;
                return state.files.find(f => f.id === state.activeFileId);
            }

            function detectLanguage(name) {
                const ext = name.split('.').pop().toLowerCase();
                const map = { js: 'javascript', html: 'html', css: 'css', json: 'json', md: 'markdown' };
                return map[ext] || 'plaintext';
            }

            function showNotification(message, type = 'info', duration = 3000) {
                clearTimeout(state.notificationTimeout);
                DOM.notification.textContent = message;
                DOM.notification.className = `notification show ${type}`;
                state.notificationTimeout = setTimeout(() => DOM.notification.classList.remove('show'), duration);
            }
            
            function initEventListeners() {
                DOM.btnRunCode.addEventListener('click', runCode);
                DOM.btnFormatCode.addEventListener('click', formatCode);
                DOM.btnFind.addEventListener('click', () => state.editor.getAction('actions.find').run());
                DOM.btnSaveNote.addEventListener('click', downloadActiveFile);
                DOM.btnOpenFile.addEventListener('click', () => DOM.fileInput.click());
                DOM.fileInput.addEventListener('change', openFile);

                DOM.tabsContainer.addEventListener('click', (e) => {
                    const tab = e.target.closest('.tab');
                    const closeBtn = e.target.closest('.close-tab');
                    const addBtn = e.target.closest('.add-tab-btn');

                    if (closeBtn) {
                        e.stopPropagation();
                        closeFile(parseInt(closeBtn.dataset.id));
                    } else if (tab) {
                        switchToFile(parseInt(tab.dataset.id));
                    } else if (addBtn) {
                        createNewFile();
                    }
                });
                
                state.editor.onDidChangeCursorPosition(updateStatusBar);
                state.editor.onDidChangeModelContent(updateStatusBar);

                DOM.themeToggle.addEventListener('change', (e) => {
                    const theme = e.target.checked ? 'dark' : 'light';
                    document.documentElement.setAttribute('data-theme', theme);
                    state.editor.updateOptions({ theme: theme === 'dark' ? 'vs-dark' : 'vs' });
                });
            }
        });
    </script>
</body>
</html>
